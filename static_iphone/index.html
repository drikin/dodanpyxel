<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">
    <meta name="description" content="DodanPyxel - iPhone最適化シューティングゲーム">
    <title>DodanPyxel - iPhone版</title>
    <link rel="stylesheet" href="style.css">
    <script>
        // iPhone向け特殊処理 - 環境変数設定
        window.IPHONE_MODE = true;
        
        // ゲーム画面の自動リサイズと最適化
        window.addEventListener('load', () => {
            // iframeの読み込み完了を待つ
            const gameFrame = document.getElementById('game-frame');
            
            gameFrame.onload = () => {
                // iframeコンテンツへのアクセス
                try {
                    const iframeWindow = gameFrame.contentWindow;
                    const iframeDoc = iframeWindow.document;
                    
                    // Pyxelキャンバスの自動検出と最適化
                    setTimeout(() => {
                        // iFrame内のキャンバスを検出
                        try {
                            const canvas = iframeDoc.querySelector('canvas');
                            if (canvas) {
                                canvas.style.width = '100%';
                                canvas.style.height = '100%';
                                canvas.style.objectFit = 'contain';
                                canvas.style.imageRendering = 'pixelated';
                                canvas.style.transform = 'translateZ(0)';
                            }
                        } catch (e) {
                            console.log('キャンバス最適化エラー:', e);
                        }
                    }, 2000);
                } catch (e) {
                    console.log('iFrameアクセスエラー:', e);
                }
                
                // 操作ガイダンス表示
                const controlsDiv = document.createElement('div');
                controlsDiv.className = 'mobile-controls';
                controlsDiv.innerHTML = '↑ 画面をタップ・ドラッグで操作 ↑';
                document.body.appendChild(controlsDiv);
                
                // 全画面表示ヒント
                const tipDiv = document.createElement('div');
                tipDiv.className = 'fullscreen-tip';
                tipDiv.innerHTML = '共有 → ホーム画面に追加<br>で全画面表示できます';
                document.body.appendChild(tipDiv);
            };
        });
        
        // ページスクロールとズームを防止する対策
        function preventBehavior(e) {
            e.preventDefault();
        }
        
        // タッチ操作の最適化
        document.addEventListener('touchmove', preventBehavior, { passive: false });
        document.addEventListener('touchstart', (e) => {
            if (e.touches.length > 1) {
                e.preventDefault();
            }
        }, { passive: false });
        
        // ダブルタップを検出してズームを防止
        document.addEventListener('dblclick', preventBehavior, { passive: false });
        
        // iOS固有の問題への対応
        window.addEventListener('gesturestart', preventBehavior, { passive: false });
        window.addEventListener('gesturechange', preventBehavior, { passive: false });
        window.addEventListener('gestureend', preventBehavior, { passive: false });
        
        // 画面の向きが変わった時のリサイズ
        window.addEventListener('orientationchange', () => {
            setTimeout(() => {
                // 画面のリサイズをトリガー
                window.dispatchEvent(new Event('resize'));
            }, 200);
        });
        
        // ゲームフレームにIPHONE_MODEフラグを伝える
        function sendFlagToGameFrame() {
            const gameFrame = document.getElementById('game-frame');
            if (gameFrame && gameFrame.contentWindow) {
                try {
                    gameFrame.contentWindow.postMessage({ iPhoneMode: true }, '*');
                } catch (e) {
                    console.log('メッセージ送信エラー:', e);
                }
            }
        }
        
        // 定期的にフラグを送信
        setInterval(sendFlagToGameFrame, 1000);
    </script>
</head>
<body>
    <iframe id="game-frame" src="/game" allowfullscreen="true"></iframe>
    
    <!-- ローディングインジケーター -->
    <div class="loading" id="loading-indicator">
        <div class="spinner"></div>
        <div class="loading-text">ゲームを読み込み中...</div>
    </div>
    
    <script>
        // ローディングインジケーター制御
        window.addEventListener('load', () => {
            setTimeout(() => {
                document.getElementById('loading-indicator').style.display = 'none';
            }, 3000);
        });
    </script>
</body>
</html>